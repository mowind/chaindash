# 多挂载点磁盘监控实施计划

## 概述
将磁盘监控从硬编码的 `/opt` 和 `/` 分区扩展为通过命令行参数配置的多分区监控。消除特殊情况，简化数据结构，保持向后兼容。

## 实施任务

### 1. 添加命令行参数支持
- [ ] **1.1 更新命令行参数定义**
  - 修改 `src/opts.rs` 文件
  - 添加 `disk_mount_points` 字段到 `Opts` 结构体
  - 使用 `#[arg(long, value_delimiter = ',', default_value = "/,/opt")]` 属性
  - **引用需求**: 1.1, 1.3 (支持配置，默认保持兼容)

- [ ] **1.2 验证参数解析**
  - 测试命令行参数解析：`--disk-mount-points /,/opt,/data`
  - 验证默认值：不指定参数时使用 `["/", "/opt"]`
  - 测试空值处理：空字符串应解析为空向量
  - **引用需求**: 5.1, 5.2 (配置验证)

### 2. 优化数据结构
- [ ] **2.1 更新 SystemStats 结构体**
  - 修改 `src/collect/collector.rs` 中的 `SystemStats` 结构体
  - 移除 `disk_available` 字段（冗余数据）
  - 添加 `disk_details: Vec<DiskDetail>` 字段
  - **引用需求**: 2.1, 2.2 (多分区数据支持)

- [ ] **2.2 创建 DiskDetail 结构体**
  - 在 `src/collect/collector.rs` 中定义 `DiskDetail` 结构体
  - 包含字段：`mount_point: String`, `total: u64`, `used: u64`, `usage_percent: f32`
  - 添加 `#[derive(Debug, Clone)]` 派生宏
  - **引用需求**: 3.1, 3.3 (详细分区信息)

### 3. 重构数据收集逻辑
- [ ] **3.1 修改 collect_system_stats 函数**
  - 更新函数签名：添加 `opts: &Opts` 参数
  - 替换硬编码的 if/else 分支为基于命令行参数的过滤
  - 使用 `opts.disk_mount_points.contains()` 进行过滤
  - **引用需求**: 1.1, 2.3 (配置驱动，汇总计算)

- [ ] **3.2 实现多分区数据收集**
  - 遍历 `sysinfo::Disks::new_with_refreshed_list()`
  - 对每个匹配的分区创建 `DiskDetail` 记录
  - 计算每个分区的使用百分比
  - 累加总空间和已使用空间
  - **引用需求**: 2.1, 2.2, 3.1 (数据收集和计算)

- [ ] **3.3 添加错误处理和边界保护**
  - 使用 `saturating_add` 和 `saturating_sub` 防止溢出
  - 添加除零保护：总空间为0时使用率设为0%
  - 记录无法访问的分区警告
  - **引用需求**: 4.1, 4.2, 4.3 (错误处理和降级)

### 4. 更新界面显示
- [ ] **4.1 修改汇总视图显示**
  - 更新 `src/widgets/system.rs` 中的磁盘显示逻辑
  - 保持现有格式：`💾 45.2% | 128.5GB / 284.3GB`
  - 使用新的 `disk_total` 和 `disk_used` 字段
  - **引用需求**: 2.4 (界面显示汇总信息)

- [ ] **4.2 添加详细视图支持（可选）**
  - 预留接口：在 `SystemStats` 中存储详细数据
  - 注释说明详细视图可作为后续增强
  - 保持界面简洁，不立即实现详细显示
  - **引用需求**: 3.2, 3.4 (详细视图框架)

### 5. 测试验证
- [ ] **5.1 单元测试：配置解析**
  - 测试默认参数解析
  - 测试自定义参数解析：`--disk-mount-points /,/opt,/data`
  - 测试边界情况：空参数、重复参数
  - **引用需求**: 5.1, 5.2, 5.3 (配置验证)

- [ ] **5.2 单元测试：数据收集逻辑**
  - 模拟 `sysinfo::Disks` 数据
  - 测试单分区监控
  - 测试多分区监控
  - 测试分区过滤逻辑
  - **引用需求**: 2.1, 2.2, 2.3 (数据收集和计算)

- [ ] **5.3 集成测试：端到端功能**
  - 启动应用并验证默认监控
  - 使用自定义参数启动：`--disk-mount-points /,/opt,/data`
  - 验证界面显示正确
  - **引用需求**: 1.4, 2.4, 3.3 (功能完整性)

### 6. 文档和清理
- [ ] **6.1 更新使用文档**
  - 在 README 或帮助文本中添加新参数说明
  - 示例：`./chaindash --disk-mount-points /,/opt,/data,/mnt/blockchain`
  - 说明默认行为保持兼容
  - **引用需求**: 1.1, 1.3 (用户文档)

- [ ] **6.2 代码清理和优化**
  - 移除未使用的 `disk_available` 相关代码
  - 确保所有编译器警告已解决
  - 运行 `cargo fmt` 和 `cargo clippy`
  - **引用需求**: 所有需求（代码质量）

## 实施顺序说明
1. **先改数据结构**（任务2）：定义好接口，确保编译通过
2. **再改数据收集**（任务3）：实现核心逻辑
3. **然后改界面**（任务4）：更新显示
4. **最后加参数**（任务1）：连接所有部分
5. **测试验证**（任务5）：确保功能正确
6. **文档清理**（任务6）：完善用户体验

## 注意事项
- **保持向后兼容**：默认参数必须为 `["/", "/opt"]`
- **渐进式增强**：先实现汇总视图，详细视图后续添加
- **错误处理**：单个分区失败不影响整体监控
- **性能考虑**：监控多个分区不应显著增加CPU开销

## 成功标准
- 应用可通过 `--disk-mount-points` 参数指定监控分区
- 默认不指定参数时监控 `/` 和 `/opt` 分区
- 界面正确显示多分区的汇总信息
- 单个分区访问失败不影响其他分区监控
- 所有现有测试通过