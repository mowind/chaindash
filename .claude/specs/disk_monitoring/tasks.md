# 磁盘监控功能实施计划

## Phase 1: 核心功能增强

### 1.1 增强数据结构
- [ ] **任务**: 扩展DiskDetail结构体以支持新功能
  - 添加`filesystem`字段存储文件系统类型
  - 添加`device`字段存储设备名称
  - 添加`is_alert`布尔字段标识告警状态
  - 添加`is_network`布尔字段标识网络挂载点
  - 添加`last_updated`字段记录最后更新时间
  - **引用需求**: 1.1（显示文件系统类型和设备名称）
- [ ] **任务**: 扩展SystemStats结构体
  - 添加`current_disk_index`字段跟踪当前选中磁盘
  - 添加`alert_threshold`字段存储告警阈值（默认90.0）
  - 添加`has_disk_alerts`布尔字段标识是否存在告警
  - **引用需求**: 2.2（告警阈值可配置）

### 1.2 实现Tab切换显示
- [ ] **任务**: 修改SystemWidget以支持Tab切换
  - 在系统监控区域添加当前磁盘指示器 "[1/3] / (45%)"
  - 实现Tab键事件处理：`current_disk_index++`
  - 实现Shift+Tab键事件处理：`current_disk_index--`
  - 确保索引循环：到达末尾时回到开头
  - **引用需求**: 1.2（Tab键切换显示）
- [ ] **任务**: 创建磁盘详细视图渲染函数
  - 在SystemWidget中添加`render_disk_details()`方法
  - 根据`current_disk_index`显示对应磁盘的详细信息
  - 格式化显示：挂载点、文件系统、设备、容量、使用率
  - 使用人类可读格式（GB/MB）
  - **引用需求**: 1.1, 1.5（显示详细信息和使用可读格式）

### 1.3 实现阈值告警
- [ ] **任务**: 在Collector中添加告警检查逻辑
  - 在`collect_system_stats()`函数中添加告警检查
  - 遍历`disk_details`，检查`usage_percent >= alert_threshold`
  - 设置`is_alert = true`并更新`has_disk_alerts`
  - **引用需求**: 2.1（90%阈值告警）
- [ ] **任务**: 在UI中实现告警高亮显示
  - 修改`render_disk_details()`以高亮显示告警状态
  - 告警磁盘使用红色文字或背景显示
  - 在系统摘要行显示告警计数 "[2 alerts]"
  - **引用需求**: 2.1, 2.3（告警高亮和清晰可见）

## Phase 2: 自动发现功能

### 2.1 实现挂载点自动发现
- [ ] **任务**: 创建挂载点发现函数
  - 创建`discover_mount_points()`函数读取`/proc/mounts`
  - 解析每行获取设备、挂载点、文件系统类型
  - 排除特殊文件系统（proc, sysfs, tmpfs, devtmpfs, cgroup, overlay）
  - 标记网络文件系统（nfs, smb, cifs）
  - **引用需求**: 3.1, 3.4, 3.5（自动发现和排除特殊FS）
- [ ] **任务**: 集成自动发现到Collector
  - 修改`collect_system_stats()`调用`discover_mount_points()`
  - 比较新发现的挂载点与现有列表
  - 添加新挂载点到监控列表
  - 移除已消失的挂载点
  - **引用需求**: 3.2（运行期间检测新挂载点）

### 2.2 实现定期检测
- [ ] **任务**: 配置自动发现间隔
  - 添加配置选项控制发现频率（默认5秒）
  - 在`SystemStats`中添加`last_discovery`时间戳
  - 只在超过间隔时才执行发现
  - **引用需求**: 3.3（5秒检测间隔）
- [ ] **任务**: 优化发现性能
  - 缓存`/proc/mounts`文件内容
  - 只在文件修改时间变化时重新解析
  - 批量处理挂载点更新
  - **引用需求**: 技术约束（低资源占用）

## Phase 3: 用户体验优化

### 3.1 改进UI布局
- [ ] **任务**: 重新设计SystemWidget磁盘区域
  - 顶部行：系统摘要（CPU、内存、磁盘汇总）
  - 中间行：磁盘Tab指示器 "[Tab: / (45%)] [/home (92%!)]"
  - 底部区域：当前磁盘详细信息表格
  - **引用需求**: 4.1, 4.3（Tab反馈和关键信息突出）
- [ ] **任务**: 添加视觉反馈和帮助
  - Tab切换时高亮当前磁盘指示器
  - 添加键盘快捷键提示 "(Tab: switch disks)"
  - 告警状态使用图标或颜色强调
  - **引用需求**: 4.1, 4.4（视觉反馈和清晰布局）

### 3.2 实现错误处理UI
- [ ] **任务**: 处理不可访问的挂载点
  - 在`DiskDetail`中添加`error`字段存储错误信息
  - UI中显示"Unavailable"或具体错误
  - 使用灰色或黄色显示错误状态
  - **引用需求**: 技术约束（健壮性）
- [ ] **任务**: 添加网络状态指示
  - 网络挂载点添加"(network)"标记
  - 超时或断开时显示警告状态
  - 提供重试或忽略选项
  - **引用需求**: 3.5（网络挂载点标记）

## Phase 4: 配置和测试

### 4.1 扩展命令行参数
- [ ] **任务**: 添加新的CLI参数
  - `--disk-alert-threshold`: 告警阈值（默认90）
  - `--disk-auto-discovery`: 启用/禁用自动发现（默认true）
  - `--disk-refresh-interval`: 磁盘刷新间隔（默认2秒）
  - 更新`src/opts.rs`中的`Opts`结构体
  - **引用需求**: 2.2（告警阈值可配置）
- [ ] **任务**: 集成配置到Collector
  - 从`Opts`读取新参数值
  - 传递给`SystemStats`和收集逻辑
  - 确保默认值合理且安全
  - **引用需求**: 技术约束（配置灵活性）

### 4.2 编写单元测试
- [ ] **任务**: 测试DiskDetail功能
  - 测试使用率计算：`used / total * 100`
  - 测试告警检查：`usage_percent >= threshold`
  - 测试数据格式化：字节转人类可读
  - **引用需求**: 成功标准（信息准确）
- [ ] **任务**: 测试挂载点发现
  - 模拟`/proc/mounts`内容进行解析测试
  - 测试特殊文件系统过滤逻辑
  - 测试网络文件系统识别
  - **引用需求**: 3.4（排除特殊FS）

### 4.3 编写集成测试
- [ ] **任务**: 测试端到端数据流
  - 创建测试Collector收集模拟磁盘数据
  - 验证数据正确传递到SystemStats
  - 验证UI正确渲染磁盘信息
  - **引用需求**: 成功标准（功能完整）
- [ ] **任务**: 测试用户交互
  - 模拟Tab键事件测试磁盘切换
  - 测试告警状态更新和显示
  - 测试自动发现功能
  - **引用需求**: 1.2, 2.1, 3.2（核心交互功能）

## Phase 5: 文档和清理

### 5.1 更新文档
- [ ] **任务**: 更新README使用说明
  - 添加磁盘监控功能说明
  - 添加新命令行参数文档
  - 添加键盘快捷键说明
  - **引用需求**: 用户体验（易用性）
- [ ] **任务**: 添加代码注释
  - 为新函数和结构体添加文档注释
  - 解释关键算法和设计决策
  - 标记TODO和未来改进点
  - **引用需求**: 代码质量（可维护性）

### 5.2 代码清理和优化
- [ ] **任务**: 性能优化
  - 分析并优化磁盘信息收集性能
  - 减少不必要的内存分配和复制
  - 确保符合资源占用约束
  - **引用需求**: 技术约束（低资源占用）
- [ ] **任务**: 代码重构
  - 提取磁盘相关功能到独立模块
  - 统一错误处理模式
  - 确保代码符合项目代码风格
  - **引用需求**: 代码质量（一致性）

## 实施说明

### 测试驱动开发指南
1. 每个任务应先编写测试，再实现功能
2. 使用模拟数据测试边缘情况
3. 确保测试覆盖所有需求验收标准
4. 运行现有测试确保不破坏现有功能

### 渐进式实施原则
1. 先实现核心数据结构扩展
2. 然后实现数据收集逻辑
3. 接着实现UI渲染
4. 最后添加配置和优化
5. 每个阶段都应可独立测试和运行

### 集成检查点
- 完成Phase 1后：Tab切换和告警应基本工作
- 完成Phase 2后：自动发现应能检测新挂载点
- 完成Phase 3后：UI应直观易用
- 完成Phase 4后：所有测试应通过
- 完成Phase 5后：代码应整洁且文档完整